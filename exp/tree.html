<!DOCTYPE html>


<html style="height: 100%; width: 100%">

<head>
  <title>Data Comets</title>

  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta charset="utf-8" />

  <!-- leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>

  <!-- Jquery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <!-- Materialize-->
  <script src="../materialize/js/materialize.js"></script>
  <link rel="stylesheet" href="../materialize/css/materialize.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- D3 -->
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-path.v1.min.js"></script>
  <script src="https://d3js.org/d3-color.v1.min.js"></script>
  <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <script src="https://d3js.org/d3-selection-multi.v0.4.min.js"></script>


</head>
<style type="text/css">
  /* 13. Basic Styling with CSS */

  /* Style the lines by removing the fill and applying a stroke */
  .line {
    fill: none;
    stroke: #ffab00;
    stroke-width: 3;
  }

  .overlay {
    fill: none;
    pointer-events: all;
  }

  /* Style the dots by assigning a fill and stroke */
  .dot {
    fill: #ffab00;
    stroke: #fff;
  }

  .focus circle {
    fill: none;
    stroke: steelblue;
  }
</style>

<body>
  <div style="width: 30%; height: 90%; overflow: auto; float: right">
    <div class="navbar-fixed">
      <nav style="width: 30%">
        <div class="nav-wrapper">
          <form  class="left" style="width: 60%">
            <div class="input-field">
              <input id="search" type="search" required>
              <label class="label-icon" for="search"><i class="material-icons">search</i></label>
              <i class="material-icons">close</i>
            </div>
          </form>
           <ul class="right">
            <li><a><i class="material-icons">arrow_upward</i></a></li>
            <li><a><i class="material-icons">unfold_less</i></a></li>
            <li><a><i class="material-icons">note_add</i></a></li>
          </ul>
        </div>
      </nav>
    </div>
    <ul class="collapsible expandable" id="tree"></ul>
  </div>
</body>
<script>
  d3.json('../data/ulg/ULG/data.json', function(data) {

    console.log('loaded', data)

    var elem = document.querySelector('.collapsible.expandable');
    var instance = M.Collapsible.init(elem, {
      accordion: false
    });

    const allEqual = arr => arr.every(v => v === arr[0])

    var ul = d3.select('#tree');

    let logs = Object.keys(data);
    
    logs.unshift("Pinned");
    logs.unshift("Overview");
    

    ul.selectAll('li')
      .data(logs)
      .enter()
      .append('li')
      .attr('id', function(d) {
        return d
      })
      .append('div')
      .attr('class', "collapsible-header")
      .html(String);

    for (let i = 0; i < logs.length; i++) {
      let log = logs[i];
      let singles = [];
      ul.select("#" + log)
        .append('div')
        .attr("class", "collapsible-body")
        .attr("id", log + '-body');
      if (log != 'Overview' && log != 'Pinned'){
      let log_data = data[log];
      let records = Object.keys(log_data[0]);
      for (let i = 0; i < records.length; i++) {

        let record = records[i];
        let vals = [];
        for (let i = 0; i < log_data.length; i++) {
          vals.push(log_data[i][record])
        }

        if (record != "timestamp" && !allEqual(vals)) {
          lineChartGen(log + "-body", {
            data: log,
            x: "timestamp",
            y: record
          });
        } else if (record != "timestamp") {
          singles.push(record)
        }
      }
      for (let i = 0; i < singles.length; i++) {

        let single = singles[i];

        var margin = {
            top: 20,
            right: 20,
            bottom: 10,
            left: 20
          },
          width = 150 // Use the window's width 
          ,
          height = 12 // Use the window's height

        var svg = d3.select('#' + log + '-body')
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

        svg.append("text").text(single + ': ' + log_data[0][single])
      }
      }

    }


    function lineChartGen(where, what) {

      df = data[what.data]
      //console.log(where)
      //console.log(what.data, what.x, what.y);
      let yVal = what.y;
      let xVal = what.x;
      let vals = [];
      for (let i = 0; i < df.length; i++) {
        vals.push(df[i][yVal]);
      }

      var margin = {
          top: 20,
          right: 10,
          bottom: 30,
          left: 30
        },
        width = 350 // Use the window's width 
        ,
        height = 100 // Use the window's height

      var svg = d3.select('#' + where)
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

      var title = svg.append("text")
        .attr("x", 0 + margin.left / 2)
        .attr("y", 0 - (margin.top / 2))
        .attr("text-anchor", "left")
        .style("font-size", "14px")
        .text(yVal);

      var x = d3.scaleLinear()
        .domain(d3.extent(df, function(d) {
          return d[xVal] / 10000000;
        }))
        .range([0, width]);
      svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));

      var y = d3.scaleLinear()
        .domain(d3.extent(df, function(d) {
          return d[yVal];
        }))
        .range([height, 0]);
      svg.append("g")
        .call(d3.axisLeft(y));

      svg.append("path")
        .datum(df)
        .attr("fill", "none")
        .attr("stroke", "steelblue")
        .attr("stroke-width", 1.5)
        .attr("d", d3.line()
          .x(function(d) {
            return x(d[xVal] / 10000000)
          })
          .y(function(d) {
            return y(d[yVal])
          })
        )
    }
  })
</script></html>
